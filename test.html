<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test Firebase Query</title>
</head>
<body>
    <h1>M·ªü Console (F12) ƒë·ªÉ xem k·∫øt qu·∫£ nh√©!</h1>
    <p id="status">ƒêang k·∫øt n·ªëi...</p>

    <script type="module">
        // 1. Nh·∫≠p th∆∞ vi·ªán Firebase tr·ª±c ti·∫øp t·ª´ CDN (Kh√¥ng c·∫ßn c√†i ƒë·∫∑t)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. C·∫•u h√¨nh c·ªßa B·∫†N
        const firebaseConfig = {
            apiKey: 'AIzaSyAc3uMaQ-1oQJW-J2U6I4qqfpf-XUKgRp0',
            authDomain: 'quan-ly-chi-tieu-1ce0f.firebaseapp.com',
            projectId: 'quan-ly-chi-tieu-1ce0f',
            storageBucket: 'quan-ly-chi-tieu-1ce0f.firebasestorage.app',
            messagingSenderId: '31622801510',
            appId: '1:31622801510:web:2d6eeb5ab18f7e3a06a5a7',
        };

        // 3. Kh·ªüi t·∫°o
        console.log("üöÄ B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o Firebase...");
        const app = initializeApp(firebaseConfig);
        console.log(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ID ·ª©ng d·ª•ng (l·∫•y t·ª´ code g·ªëc c·ªßa b·∫°n)
        const appId = 'quan-ly-chi-tieu-personal';

        // 4. H√†m ch·∫°y ch√≠nh
        async function runTest() {
            try {
                // B∆Ø·ªöC 1: ƒêƒÉng nh·∫≠p (Ph·∫£i ƒëƒÉng nh·∫≠p m·ªõi ƒë∆∞·ª£c ƒë·ªçc d·ªØ li·ªáu - Lu·∫≠t c·ªßa Firebase)
                // ·ªû ƒë√¢y m√¨nh d√πng ƒëƒÉng nh·∫≠p ·∫©n danh cho nhanh
                console.log("üîê ƒêang ƒëƒÉng nh·∫≠p ·∫©n danh...");
                await signInAnonymously(auth);
                console.log(auth);
                console.log("‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! User ID:", auth.currentUser.uid);

                // B∆Ø·ªöC 2: ƒê·ªãnh nghƒ©a ƒë∆∞·ªùng d·∫´n (Path)
                // D·ª±a theo code App_v4.jsx c·ªßa b·∫°n, ƒë∆∞·ªùng d·∫´n cho kh√°ch v√£ng lai l√†:
                // artifacts -> quan-ly-chi-tieu-personal -> public -> data -> transactions
                const pathSegments = ['artifacts', appId, 'public', 'data', 'transactions'];
                
                console.log("üìÇ ƒêang tr·ªè t·ªõi ƒë∆∞·ªùng d·∫´n:", pathSegments.join('/'));
                
                // T·∫°o tham chi·∫øu (Reference) t·ªõi collection
                const transactionsRef = collection(db, ...pathSegments);

                // B∆Ø·ªöC 3: QUERY (L·∫•y d·ªØ li·ªáu v·ªÅ)
                console.log("‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Server...");
                const snapshot = await getDocs(transactionsRef);
                console.log(snapshot);               
                console.log(snapshot.docs[0].data.bind.name);
                console.log(Object.getPrototypeOf(Object.getPrototypeOf(snapshot)));

                // B∆Ø·ªöC 4: Hi·ªÉn th·ªã k·∫øt qu·∫£
                if (snapshot.empty) {
                    console.warn("‚ö†Ô∏è K·∫øt n·ªëi th√†nh c√¥ng nh∆∞ng kh√¥ng c√≥ giao d·ªãch n√†o (Collection r·ªóng).");
                    document.getElementById('status').innerText = "K·∫øt n·ªëi OK - Kh√¥ng c√≥ d·ªØ li·ªáu.";
                } else {
                    console.log(`üéâ ƒê√£ t√¨m th·∫•y ${snapshot.size} giao d·ªãch!`);
                    
                    // In chi ti·∫øt t·ª´ng giao d·ªãch ra Console d·∫°ng b·∫£ng cho ƒë·∫πp
                    const dataList = snapshot.docs.map(doc => ({
                        ID: doc.id,
                        ...doc.data(),
                        // Convert ng√†y th√°ng cho d·ªÖ ƒë·ªçc n·∫øu c√≥
                        date: doc.data().date 
                    }));
                    
                    console.table(dataList); // D√πng console.table nh√¨n si√™u ƒë·∫πp
                    document.getElementById('status').innerText = `Th√†nh c√¥ng! Xem Console ƒë·ªÉ th·∫•y ${snapshot.size} d√≤ng d·ªØ li·ªáu.`;
                }

            } catch (error) {
                console.error("‚ùå L·ªói r·ªìi:", error);
                document.getElementById('status').innerText = "L·ªói: " + error.message;
            }
        }

        // Ch·∫°y ngay
        runTest();
    </script>
</body>
</html>