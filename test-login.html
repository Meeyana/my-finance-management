<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test ÄÄƒng Nháº­p User Cá»¥ Thá»ƒ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; display: block; margin-bottom: 10px; width: 300px;}
        button { padding: 10px 20px; background: #2563EB; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;}
        button:hover { background: #1d4ed8; }
        .log-box { background: #f4f4f5; padding: 15px; border-radius: 10px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>ÄÄƒng nháº­p User cá»¥ thá»ƒ</h2>
    
    <input type="email" id="email" placeholder="Nháº­p email (vd: test@gmail.com)" value="phandinhtuan1112@gmail.com">
    <input type="password" id="password" placeholder="Nháº­p máº­t kháº©u (vd: 123456)" value="Gfdtgerr1">
    <button onclick="handleLogin()">ÄÄƒng Nháº­p & Láº¥y Dá»¯ Liá»‡u</button>

    <div id="console" class="log-box">Chá» thao tÃ¡c...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // Láº§n nÃ y nháº­p thÃªm signInWithEmailAndPassword
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: 'AIzaSyAc3uMaQ-1oQJW-J2U6I4qqfpf-XUKgRp0',
            authDomain: 'quan-ly-chi-tieu-1ce0f.firebaseapp.com',
            projectId: 'quan-ly-chi-tieu-1ce0f',
            storageBucket: 'quan-ly-chi-tieu-1ce0f.firebasestorage.app',
            messagingSenderId: '31622801510',
            appId: '1:31622801510:web:2d6eeb5ab18f7e3a06a5a7',
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        console.log(auth);
        const db = getFirestore(app);
        const appId = 'quan-ly-chi-tieu-personal';

        // HÃ m log ra mÃ n hÃ¬nh cho dá»… nhÃ¬n
        function log(msg) {
            document.getElementById('console').innerText += "\n" + msg;
            console.log(msg);
        }

        // ÄÆ°a hÃ m ra window Ä‘á»ƒ nÃºt báº¥m HTML gá»i Ä‘Æ°á»£c
        window.handleLogin = async function() {
            document.getElementById('console').innerText = "â³ Äang xá»­ lÃ½...";
            
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;

            try {
                // 1. ÄÄ‚NG NHáº¬P (QUAN TRá»ŒNG NHáº¤T)
                log(`ğŸ”‘ Äang Ä‘Äƒng nháº­p vá»›i: ${email}...`);
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                console.log(userCredential);
                const user = userCredential.user;
                console.log(user);

                log(`âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!`);
                log(`ğŸ‘¤ User UID: ${user.uid}`);
                log(`ğŸ“§ Email: ${user.email}`);

                // 2. XÃC Äá»ŠNH ÄÆ¯á»œNG DáºªN RIÃŠNG TÆ¯
                // Logic nÃ y láº¥y y há»‡t tá»« file App_v4.jsx cá»§a báº¡n (hÃ m getFirestorePaths)
                // ÄÆ°á»ng dáº«n: artifacts -> [appId] -> users -> [UID Cá»¦A USER] -> transactions
                const pathSegments = ['artifacts', appId, 'users', user.uid, 'transactions'];
                
                log(`ğŸ“‚ Äang trá» vÃ o kho dá»¯ liá»‡u cÃ¡ nhÃ¢n: \n   ${pathSegments.join('/')}`);

                // 3. Láº¤Y Dá»® LIá»†U
                const transactionsRef = collection(db, ...pathSegments);
                console.log(transactionsRef);
                const docSnap = await getDocs(transactionsRef);
                console.log(docSnap);
                console.log(docSnap.docs[0].data());

                const datafetch = docSnap.forEach(doc => {
                    log(`${doc.id}, ${doc.data().note}, ${doc.data().amount}`);
                })
               

            } catch (error) {
                log(`âŒ Lá»—i: ${error.message}`);
                if (error.code === 'auth/invalid-credential') {
                    log("ğŸ‘‰ Gá»£i Ã½: Kiá»ƒm tra láº¡i email hoáº·c máº­t kháº©u.");
                }
            }
        };
    </script>
</body>
</html>