rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTION: CHECK ACCESS ---
    function canWrite() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      let data = userDoc.data;

      // 1. Unlimited / Lifetime Access
      let isUnlimited = "isUnlimited" in data && (data.isUnlimited == true || data.isUnlimited == "true");
      
      // 2. Date-Based Premium Access
      // Check if 'isPremium' exists AND is a Timestamp AND is in the future.
      // Note: 'isPremium' is now used as the Expiration Date field.
      let isDateValid = "isPremium" in data && 
                        (data.isPremium is timestamp) && 
                        (data.isPremium.toMillis() > request.time.toMillis());

      // 3. Trial Period (7 Days)
      let isTrial = (request.time.toMillis() - data.createdAt.toMillis()) < (7 * 24 * 60 * 60 * 1000);

      // GRANT if any of the above is true
      return isUnlimited || isDateValid || isTrial;
    }

    // --- PART 1: PUBLIC / DEMO ---
    match /artifacts/quan-ly-chi-tieu-personal/public/data/{document=**} {
      allow read, write: if true; 
    }

    // --- PART 2: GENUINE USERS (PRIVATE) ---
    match /artifacts/quan-ly-chi-tieu-personal/users/{userId}/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId && canWrite();
    }

    // --- USER PROFILE ---
    match /users/{userId} {
      allow read, create: if request.auth != null && request.auth.uid == userId;
      allow update: if false; // No need for self-downgrade anymore!
    }
  }
}
